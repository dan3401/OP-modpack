namespace = action

# Assimilate Pops on Yearly Pulse
event = {
	id = action.64
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		log = "action.64"
        every_playable_country = {
            limit = {
                num_unique_species > 1
                any_owned_species = {
                    has_citizenship_type = {
						type = citizenship_assimilation
						country = prev
                    }
                }
            }
			log = "action.64.epc"

			if = { # ascended synths
				limit = {
					NOT = { has_country_flag = synthetic_empire }
				}
				every_owned_species = {
					limit = {
						has_citizenship_type = {
							type = citizenship_assimilation
							country = prev
						}
					}
					if = { # assimilator empire or cyborg empire
						limit = {
							prev = {														# Можно ассимилировать в киборгов если
								OR = {														# Страна обладает чем-то из этого:
									has_country_flag = flesh_weakened						# -Есть выполненный проект Плоть Слаба
									AND = {													# -- 
										has_authority = auth_machine_intelligence			# -- Страна является Машинным интеллектом
										has_civic = civic_machine_assimilator				# -- С перкой Машинного ассимилятора
									}														# --
								}															#
								NOT = {													#MOD# Но страна не должна обладать
									has_ascension_perk = ap_transcendence				#MOD# перкой "Трансценденция"
								}														#MOD#
							}																#
						}
						if = {
							limit = { NOT = { has_trait = trait_cybernetic } }
							if = {
								limit = {
									has_trait = trait_hive_mind
									has_trait = trait_self_modified
								}
								modify_species = {
									species = this
									add_trait = trait_cybernetic
									add_traits_at_start_of_list = yes
									remove_trait = trait_hive_mind
									remove_trait = trait_self_modified
									change_scoped_species = no

									effect = {
										set_timed_species_flag = {
											flag = assimilation_species_of_species@prev
											days = 30
										}
										set_timed_species_flag = {
											flag = assimilation_species_of_empire@prevprev
											days = 30
										}
									}
								}
							}
							else_if = {
								limit = {
									has_trait = trait_hive_mind
								}
								modify_species = {
									species = this
									add_trait = trait_cybernetic
									add_traits_at_start_of_list = yes
									remove_trait = trait_hive_mind
									change_scoped_species = no

									effect = {
										set_timed_species_flag = {
											flag = assimilation_species_of_species@prev
											days = 30
										}
										set_timed_species_flag = {
											flag = assimilation_species_of_empire@prevprev
											days = 30
										}
									}
								}
							}
							else_if = {
								limit = {
									has_trait = trait_self_modified
								}
								modify_species = {
									species = this
									add_trait = trait_cybernetic
									add_traits_at_start_of_list = yes
									remove_trait = trait_self_modified
									change_scoped_species = no

									effect = {
										set_timed_species_flag = {
											flag = assimilation_species_of_species@prev
											days = 30
										}
										set_timed_species_flag = {
											flag = assimilation_species_of_empire@prevprev
											days = 30
										}
									}
								}
							}
							else = {
								modify_species = {
									species = this
									add_trait = trait_cybernetic
									add_traits_at_start_of_list = yes
									change_scoped_species = no

									effect = {
										set_timed_species_flag = {
											flag = assimilation_species_of_species@prev
											days = 30
										}
										set_timed_species_flag = {
											flag = assimilation_species_of_empire@prevprev
											days = 30
										}
									}
								}
							}
						}
					}
					else_if = { # hive mind
						limit = {
							prev = {
								has_authority = auth_hive_mind
								NOT = { has_civic = civic_hive_devouring_swarm }
							}
						}
						if = {
							limit = {
								has_trait = trait_self_modified
							}
							modify_species = {
								species = this
								add_trait = trait_hive_mind
								remove_trait = trait_self_modified
								change_scoped_species = no

								effect = {
									set_timed_species_flag = {
										flag = assimilation_species_of_species@prev
										days = 30
									}
									set_timed_species_flag = {
										flag = assimilation_species_of_empire@prevprev
										days = 30
									}
								}
							}
						}
						else = {
							modify_species = {
								species = this
								add_trait = trait_hive_mind
								change_scoped_species = no

								effect = {
									set_timed_species_flag = {
										flag = assimilation_species_of_species@prev
										days = 30
									}
									set_timed_species_flag = {
										flag = assimilation_species_of_empire@prevprev
										days = 30
									}
								}
							}
						}
					}
					else_if = {
						limit = {
							prev = {
								NOR = {
									has_ethic = ethic_gestalt_consciousness
									has_country_flag = synthetic_empire
									has_country_flag = flesh_weakened
								}
							}
							has_trait = trait_hive_mind
						}
						modify_species = {
							species = this
							remove_trait = trait_hive_mind
							change_scoped_species = no

							effect = {
								set_timed_species_flag = {
									flag = assimilation_species_of_species@prev
									days = 30
								}
								set_timed_species_flag = {
									flag = assimilation_species_of_empire@prevprev
									days = 30
								}
							}
						}
					}
					else_if = { #### Psionic Assimilation ADD OTHER RANDOM OPTIONS TOO
						limit = {															#
							prev = {														# можно ассимилировать в псиоников если страна обладает
								has_ascension_perk = ap_transcendence						# перкой трансценденций
								NOT = {	has_country_flag = flesh_weakened }				#MOD# нет выполненного проекта плоть слаба
							}																# 
						}
						if = {
							limit = {
								NOR = {
									has_trait = trait_psionic
									has_trait = trait_latent_psionic
								}
							}
							modify_species = {
								species = this
								add_trait = trait_psionic
								add_traits_at_start_of_list = yes
								change_scoped_species = no

								effect = {
									set_timed_species_flag = {
										flag = assimilation_species_of_species@prev
										days = 30
									}
									set_timed_species_flag = {
										flag = assimilation_species_of_empire@prevprev
										days = 30
									}
								}
							}
						}
						else_if = {
							limit = {
								NOT = { has_trait = trait_psionic}
								has_trait = trait_latent_psionic
							}
							modify_species = {
								species = this
								remove_trait = trait_latent_psionic
								add_trait = trait_psionic
								add_traits_at_start_of_list = yes
								change_scoped_species = no

								effect = {
									set_timed_species_flag = {
										flag = assimilation_species_of_species@prev
										days = 30
									}
									set_timed_species_flag = {
										flag = assimilation_species_of_empire@prevprev
										days = 30
									}
								}
							}
						}
					}
#################### DOUBLE ASSIMILATION BY KERHUS ####################
					else_if = { #### PSIBORG ASSIMILATION
						limit = {															#
							prev = {														# можно ассимилировать в псиоников и киборгов если страна обладает
								has_ascension_perk = ap_transcendence						# перкой трансценденций
								has_country_flag = flesh_weakened							# выполненным проектом плоть слаба
							}																# 
						}
						if = {																# НЕТ псионика, латентного псионика, киборга
							limit = {
								NOR = {
									has_trait = trait_psionic
									has_trait = trait_latent_psionic
									has_trait = trait_cybernetic
								}
							}
							modify_species = {
								species = this
								add_trait = trait_psionic
								add_trait = trait_cybernetic
								add_traits_at_start_of_list = yes
								change_scoped_species = no

								effect = {
									set_timed_species_flag = {
										flag = assimilation_species_of_species@prev
										days = 30
									}
									set_timed_species_flag = {
										flag = assimilation_species_of_empire@prevprev
										days = 30
									}
								}
							}
						}
						else_if = {															# НЕТ псионика, латентного псионика, ЕСТЬ киборг
							limit = {
								has_trait = trait_cybernetic
								NOR = {
									has_trait = trait_psionic
									has_trait = trait_latent_psionic
								}
							}
							modify_species = {
								species = this
								add_trait = trait_psionic
								add_traits_at_start_of_list = yes
								change_scoped_species = no

								effect = {
									set_timed_species_flag = {
										flag = assimilation_species_of_species@prev
										days = 30
									}
									set_timed_species_flag = {
										flag = assimilation_species_of_empire@prevprev
										days = 30
									}
								}
							}
						}
						else_if = {															# НЕТ псионика, ЕСТЬ латентный псионик, киборг
							limit = {
								NOT = { has_trait = trait_psionic}
								has_trait = trait_latent_psionic
								has_trait = trait_cybernetic
							}
							modify_species = {
								species = this
								remove_trait = trait_latent_psionic
								add_trait = trait_psionic
								add_traits_at_start_of_list = yes
								change_scoped_species = no

								effect = {
									set_timed_species_flag = {
										flag = assimilation_species_of_species@prev
										days = 30
									}
									set_timed_species_flag = {
										flag = assimilation_species_of_empire@prevprev
										days = 30
									}
								}
							}
						}
						else_if = {															# НЕТ псионика, киборга, ЕСТЬ латентный псионик
							limit = {
								NOR = { 
									has_trait = trait_psionic
									has_trait = trait_cybernetic
								}
								has_trait = trait_latent_psionic
							}
							modify_species = {
								species = this
								remove_trait = trait_latent_psionic
								add_trait = trait_psionic
								add_trait = trait_cybernetic
								add_traits_at_start_of_list = yes
								change_scoped_species = no

								effect = {
									set_timed_species_flag = {
										flag = assimilation_species_of_species@prev
										days = 30
									}
									set_timed_species_flag = {
										flag = assimilation_species_of_empire@prevprev
										days = 30
									}
								}
							}
						}
					}
#######################################################################
				}
			}

            every_owned_planet = {
                planet_event = { id = action.65 }
            }
        }
    }
}